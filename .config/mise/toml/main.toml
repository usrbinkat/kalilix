# Main Kalilix Tasks
# Primary entry points and commands

["help"]
description = "ðŸ“š Show Kalilix help and available tasks"
run = '''
#!/usr/bin/env bash
set -euo pipefail

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘            ðŸš€ Kalilix Development Environment                 â•‘"
echo "â•‘         Enterprise Polyglot Development with Nix              â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "Quick Start:"
echo "  mise run setup              # ðŸ”§ Initial setup (detect platform, install Nix)"
echo "  mise run shell              # ðŸš Enter default development shell"
echo "  mise run shell:python       # ðŸ Enter Python development shell"
echo "  mise run status             # ðŸ“Š Check environment status"
echo ""
echo "Core Commands:"
echo "  mise run nix:install        # ðŸ“¦ Install Nix (if not present)"
echo "  mise run nix:shell [name]   # ðŸš Enter specific Nix shell"
echo "  mise run nix:update         # ðŸ”„ Update flake inputs"
echo "  mise run nix:build          # ðŸ”¨ Build current configuration"
echo ""
echo "Container Operations:"
echo "  mise run docker:up          # ðŸ³ Start devcontainer"
echo "  mise run docker:down        # ðŸ›‘ Stop devcontainer"
echo "  mise run docker:shell       # ðŸ’» Enter container shell"
echo "  mise run docker:build       # ðŸ—ï¸ Build container image"
echo ""
echo "Development Shells:"
echo "  mise run dev:python         # ðŸ Python environment"
echo "  mise run dev:go            # ðŸ¹ Go environment"
echo "  mise run dev:rust          # ðŸ¦€ Rust environment"
echo "  mise run dev:node          # ðŸŸ¢ Node.js environment"
echo "  mise run dev:devops        # âš™ï¸ DevOps tools environment"
echo ""
echo "Operational:"
echo "  mise run clean              # ðŸ§¹ Clean build artifacts"
echo "  mise run check              # âœ… Run all checks"
echo "  mise run format             # ðŸ“ Format code"
echo "  mise run test               # ðŸ§ª Run tests"
echo ""
echo "Advanced:"
echo "  mise run kx [command]       # ðŸŽ® Kalilix CLI interface"
echo "  mise run cache:push         # ðŸ“¤ Push to binary cache"
echo "  mise run info               # â„¹ï¸ Show detailed environment info"
echo ""
echo "Environment: ${PROJECT_ENV:-development}"
echo "Platform: ${KALILIX_PLATFORM:-detecting...}"
echo ""
echo "Run 'mise tasks' to see all available tasks"
echo "Documentation: https://github.com/${PROJECT_ORG}/${PROJECT_NAME}"
'''

["setup"]
description = "ðŸ”§ Initial Kalilix environment setup"
depends = ["setup:detect-platform", "setup:check-requirements", "setup:install-nix", "setup:init-flake"]

["status"]
description = "ðŸ“Š Show environment status"
run = '''
#!/usr/bin/env bash
set -euo pipefail

echo "Kalilix Environment Status"
echo "=========================="
echo ""

# Platform detection
if [ -f /.dockerenv ] || [ -n "${KALILIX_IN_CONTAINER:-}" ]; then
    echo "Platform: ðŸ³ Container"
    PLATFORM="docker"
elif [ -n "${WSL_DISTRO_NAME:-}" ]; then
    echo "Platform: ðŸªŸ WSL"
    PLATFORM="wsl"
else
    echo "Platform: ðŸ’» Native"
    PLATFORM="native"
fi

echo ""
echo "Components:"

# Check Nix
if command -v nix &>/dev/null; then
    echo "  âœ… Nix: $(nix --version)"
else
    echo "  âŒ Nix: Not installed (run 'mise run setup')"
fi

# Check Docker
if command -v docker &>/dev/null; then
    echo "  âœ… Docker: $(docker --version | cut -d' ' -f3 | tr -d ',')"
else
    echo "  âš ï¸  Docker: Not available"
fi

# Check flake
if [ -f flake.nix ]; then
    echo "  âœ… Flake: Configured"
    if [ -f flake.lock ]; then
        echo "  âœ… Lock: Present"
    else
        echo "  âš ï¸  Lock: Missing (run 'mise run nix:update')"
    fi
else
    echo "  âŒ Flake: Not configured (run 'mise run setup:init-flake')"
fi

# Check devcontainer
if docker ps --format 'table {{"{{.Names}}"}}' | grep -q "${COMPOSE_PROJECT_NAME}" 2>/dev/null; then
    echo "  âœ… Container: Running"
else
    echo "  âš ï¸  Container: Not running"
fi

echo ""
echo "Configuration:"
echo "  Project: ${PROJECT_NAME}"
echo "  Organization: ${PROJECT_ORG}"
echo "  Environment: ${PROJECT_ENV}"
echo "  Default Shell: ${KALILIX_SHELL}"
echo ""
'''

["shell"]
description = "ðŸš Enter default Nix development shell"
run = '''
#!/usr/bin/env bash
mise run nix:shell "${KALILIX_SHELL:-base}"
'''

["shell:*"]
description = "ðŸš Enter specific Nix development shell"
run = '''
#!/usr/bin/env bash
SHELL_NAME="${1:-${MISE_TASK_NAME#shell:}}"
mise run nix:shell "$SHELL_NAME"
'''

["clean"]
description = "ðŸ§¹ Clean all build artifacts and caches"
run = '''
#!/usr/bin/env bash
set -euo pipefail

echo "ðŸ§¹ Cleaning Kalilix build artifacts..."

# Clean Nix artifacts
if [ -d result ]; then
    echo "  Removing Nix result links..."
    rm -rf result result-*
fi

# Clean build directory
if [ -d "${BUILD_DIR:-.build}" ]; then
    echo "  Removing build directory..."
    rm -rf "${BUILD_DIR:-.build}"
fi

# Clean direnv
if [ -d .direnv ]; then
    echo "  Removing direnv cache..."
    rm -rf .direnv
fi

# Optional: Nix garbage collection
read -p "Run Nix garbage collection? (y/N) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "  Running Nix garbage collection..."
    nix-collect-garbage -d
fi

echo "âœ… Cleanup complete!"
'''

["info"]
description = "â„¹ï¸ Show detailed environment information"
run = ".config/mise/tasks/kx info"

["kx"]
description = "ðŸŽ® Kalilix CLI - main command interface"
run = ".config/mise/tasks/kx"

["kx:*"]
description = "ðŸŽ® Run Kalilix CLI command"
run = '''
#!/usr/bin/env bash
COMMAND="${MISE_TASK_NAME#kx:}"
shift 2>/dev/null || true
.config/mise/tasks/kx "$COMMAND" "$@"
'''