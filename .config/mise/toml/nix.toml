# Nix Flakes Management Tasks
# Core Nix operations for the Kalilix development environment

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# üì¶ NIX PACKAGE MANAGER OPERATIONS
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

["nix:install"]
description = "üì¶ Install Nix package manager (platform-aware)"
env.NIX_INSTALLER_URL = "{{ vars.nix_installer_url }}"
env.NIX_VERSION = "{{ vars.nix_version }}"
run = '''
#!/usr/bin/env bash
set -euo pipefail

echo "üì¶ Installing Nix package manager..."
echo ""

# Check if Nix is already installed
if command -v nix &>/dev/null; then
    echo "‚úÖ Nix is already installed: $(nix --version)"
    echo ""
    echo "To reinstall, first run: mise run nix:uninstall"
    exit 0
fi

# Detect platform
if [ -f /.dockerenv ] || [ -n "${KALILIX_IN_CONTAINER:-}" ]; then
    echo "üê≥ Detected container environment"
    PLATFORM="container"
elif [ -n "${WSL_DISTRO_NAME:-}" ]; then
    echo "ü™ü Detected WSL environment"
    PLATFORM="wsl"
elif [[ "$OSTYPE" == "darwin"* ]]; then
    echo "üçé Detected macOS"
    PLATFORM="macos"
else
    echo "üíª Detected native Linux"
    PLATFORM="linux"
fi

# Run platform-specific installer
${KALILIX_ROOT}/.config/mise/tasks/nix-bootstrap "$PLATFORM"
'''

["nix:uninstall"]
description = "üóëÔ∏è Uninstall Nix package manager"
run = '''
#!/usr/bin/env bash
set -uo pipefail

echo "üóëÔ∏è Uninstalling Nix..."
echo ""

if [ ! -f /nix/receipt.json ]; then
    echo "‚ö†Ô∏è  No Nix installation receipt found"
    echo "    Manual cleanup may be required"
else
    if [ -f /nix/nix-installer ]; then
        echo "Using Determinate Systems uninstaller..."
        /nix/nix-installer uninstall --no-confirm
    else
        echo "‚ö†Ô∏è  Uninstaller not found, manual cleanup required:"
        echo "    sudo rm -rf /nix"
        echo "    Remove Nix entries from shell profiles"
    fi
fi
'''

["nix:shell"]
description = "üêö Enter a Nix development shell"
run = '''
#!/usr/bin/env bash
set -euo pipefail

SHELL_NAME="${1:-${KALILIX_SHELL:-base}}"

echo "üêö Entering Nix shell: $SHELL_NAME"
echo ""

# Check if flake exists
if [ ! -f "${FLAKE_DIR}/flake.nix" ]; then
    echo "‚ùå No flake.nix found!"
    echo "   Run 'mise run setup:init-flake' first"
    exit 1
fi

# Check if Nix is installed
if ! command -v nix &>/dev/null; then
    echo "‚ùå Nix is not installed!"
    echo "   Run 'mise run nix:install' first"
    exit 1
fi

# Enter the requested shell
cd "$FLAKE_DIR"
case "$SHELL_NAME" in
    base|default)
        nix develop --impure
        ;;
    *)
        nix develop ".#$SHELL_NAME" --impure
        ;;
esac
'''

["nix:update"]
description = "üîÑ Update flake inputs to latest versions"
run = '''
#!/usr/bin/env bash
set -euo pipefail

echo "üîÑ Updating Nix flake inputs..."
echo ""

cd "$FLAKE_DIR"

# Check if flake exists
if [ ! -f flake.nix ]; then
    echo "‚ùå No flake.nix found in $FLAKE_DIR"
    exit 1
fi

# Update flake inputs
echo "üì• Fetching latest input versions..."
nix flake update

# Show what changed
echo ""
echo "üìã Changes in flake.lock:"
if command -v git &>/dev/null && [ -d .git ]; then
    git diff flake.lock || true
fi

echo ""
echo "‚úÖ Flake inputs updated!"
echo "   Run 'mise run nix:shell' to use updated dependencies"
'''

["nix:build"]
description = "üî® Build the current Nix configuration"
run = '''
#!/usr/bin/env bash
set -euo pipefail

echo "üî® Building Nix configuration..."
echo ""

cd "$FLAKE_DIR"

# Build all outputs
echo "Building flake outputs..."
nix build --json | jq -r '.[].outputs | to_entries[].value' || nix build

echo ""
echo "‚úÖ Build complete!"
ls -la result* 2>/dev/null || echo "No result links created"
'''

["nix:develop"]
description = "üõ†Ô∏è Enter development shell with all tools"
run = '''
#!/usr/bin/env bash
set -euo pipefail

echo "üõ†Ô∏è Entering full development environment..."
echo ""

cd "$FLAKE_DIR"

# Enter development shell with all tools
nix develop --impure --command bash -c '
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë              Kalilix Development Environment                   ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo ""
    echo "Available commands:"
    echo "  kx          - Kalilix CLI"
    echo "  kx-info     - Environment information"
    echo "  kx-update   - Update dependencies"
    echo "  kx-clean    - Clean Nix store"
    echo ""
    exec bash
'
'''

["nix:gc"]
description = "‚ôªÔ∏è Garbage collect Nix store"
run = '''
#!/usr/bin/env bash
set -euo pipefail

echo "‚ôªÔ∏è Running Nix garbage collection..."
echo ""

# Show current store size
echo "Current Nix store size:"
du -sh /nix/store 2>/dev/null || echo "Unable to determine"
echo ""

# Run garbage collection
if [ "${1:-}" = "--aggressive" ]; then
    echo "Running aggressive garbage collection..."
    nix-collect-garbage -d
    nix-store --optimise
else
    echo "Running standard garbage collection..."
    nix-collect-garbage
fi

echo ""
echo "New Nix store size:"
du -sh /nix/store 2>/dev/null || echo "Unable to determine"
echo ""
echo "‚úÖ Garbage collection complete!"
'''

["nix:search"]
description = "üîç Search for packages in nixpkgs"
run = '''
#!/usr/bin/env bash
set -euo pipefail

QUERY="${1:?Usage: mise run nix:search <package>}"

echo "üîç Searching nixpkgs for: $QUERY"
echo ""

nix search nixpkgs "$QUERY" 2>/dev/null | head -50

echo ""
echo "üí° To see more results, run: nix search nixpkgs $QUERY"
'''

["nix:info"]
description = "‚ÑπÔ∏è Show Nix installation information"
run = '''
#!/usr/bin/env bash
set -euo pipefail

echo "Nix Installation Information"
echo "============================"
echo ""

if ! command -v nix &>/dev/null; then
    echo "‚ùå Nix is not installed"
    exit 1
fi

echo "Version: $(nix --version)"
echo ""

echo "Configuration:"
nix show-config | head -20
echo ""

echo "Channels:"
nix-channel --list 2>/dev/null || echo "No channels configured (using flakes)"
echo ""

echo "Flake registries:"
nix registry list | head -10
echo ""

echo "Store path: $(nix-store --print-build-paths 2>/dev/null | head -1 | xargs dirname 2>/dev/null || echo /nix/store)"
echo "Store size: $(du -sh /nix/store 2>/dev/null | cut -f1 || echo 'Unknown')"
echo ""

if [ -f /nix/receipt.json ]; then
    echo "Installation receipt found:"
    jq -r '.planner' /nix/receipt.json 2>/dev/null || cat /nix/receipt.json
fi
'''

["nix:doctor"]
description = "üè• Check Nix installation health"
run = '''
#!/usr/bin/env bash
set -uo pipefail

echo "üè• Running Nix health check..."
echo ""

# Check Nix command
if command -v nix &>/dev/null; then
    echo "‚úÖ Nix command available: $(nix --version)"
else
    echo "‚ùå Nix command not found"
    exit 1
fi

# Verify experimental features are enabled
if ! grep -q "experimental-features.*nix-command.*flakes" /etc/nix/nix.conf 2>/dev/null && \
   ! grep -q "experimental-features.*nix-command.*flakes" ~/.config/nix/nix.conf 2>/dev/null; then
    echo "‚ùå Experimental features not enabled - run 'mise run nix:cache:configure'"
    exit 1
fi
echo "‚úÖ Experimental features enabled (nix-command flakes)"

# Verify flakes support works
if ! nix flake --help &>/dev/null 2>&1; then
    echo "‚ùå Flakes support not available"
    exit 1
fi
echo "‚úÖ Flakes support available"

# Verify store exists
if [ ! -d /nix/store ]; then
    echo "‚ùå Nix store not found"
    exit 1
fi
echo "‚úÖ Nix store exists"

# Check for flake.nix first
if [ ! -f "${FLAKE_DIR}/flake.nix" ]; then
    echo "‚ùå No flake.nix found"
    exit 1
fi
echo "‚úÖ flake.nix present"

# Wait for nix-daemon to be fully ready and responsive
if command -v systemctl &>/dev/null; then
    echo "Waiting for nix-daemon to be ready..."
    for i in {1..30}; do
        if systemctl is-active --quiet nix-daemon 2>/dev/null; then
            # Daemon is active, now test if it's responsive
            if nix store ping --store daemon 2>/dev/null; then
                echo "‚úÖ Nix daemon is active and responsive"
                break
            fi
        fi
        sleep 1
    done
fi

# Give daemon a moment to fully initialize
sleep 2

# Verify flake evaluates successfully
echo "Validating flake configuration..."
if cd "$FLAKE_DIR" && nix flake check --impure 2>&1 | tee /tmp/flake-check.log; then
    echo "‚úÖ Flake evaluation successful"
else
    echo "‚ùå Flake evaluation failed"
    echo "Error output:"
    cat /tmp/flake-check.log
    exit 1
fi

echo ""
echo "Overall status: Check complete"
'''

["nix:cache:configure"]
description = "üíæ Configure Lix/Nix binary caches"
run = '''
#!/usr/bin/env bash
set -euo pipefail

echo "üíæ Configuring Lix binary caches..."
echo ""

# Ensure Nix is installed
if ! command -v nix &>/dev/null; then
    echo "‚ùå Nix/Lix not installed. Run 'mise run nix:install' first."
    exit 1
fi

# Create Nix configuration directory
mkdir -p ~/.config/nix

# Configure nix.conf - minimal config, let flake.nix provide caches/keys
cat > ~/.config/nix/nix.conf <<'EOF'
# Kalilix Lix/Nix Configuration
# Minimal user config - flake.nix provides substituters and keys via nixConfig

# Experimental Features (Flakes + nix-command)
experimental-features = nix-command flakes

# Trust flake-provided configuration (caches, keys, build settings)
accept-flake-config = true

# Optimization
auto-optimise-store = true
warn-dirty = false
allow-import-from-derivation = true
EOF

echo "‚úÖ Nix user configuration created"
echo "   Location: ~/.config/nix/nix.conf"
echo "   Flake config: Trusted (flake.nix provides caches and keys)"
echo ""

# Configure current user as trusted in system-wide config
if command -v sudo &>/dev/null; then
    CURRENT_USER="${USER}"
    echo "üîê Adding current user ($CURRENT_USER) to trusted-users..."

    # Check if already configured
    if sudo grep -q "^trusted-users.*$CURRENT_USER" /etc/nix/nix.conf 2>/dev/null; then
        echo "   Already configured as trusted user"
    else
        # Add trusted-users line if it doesn't exist
        if ! sudo grep -q "^trusted-users" /etc/nix/nix.conf 2>/dev/null; then
            echo "trusted-users = root $CURRENT_USER" | sudo tee -a /etc/nix/nix.conf >/dev/null
        else
            # Append to existing trusted-users line (portable across GNU and BSD sed)
            sudo sh -c "sed 's/^trusted-users =.*/& '$CURRENT_USER'/' /etc/nix/nix.conf > /etc/nix/nix.conf.tmp && mv /etc/nix/nix.conf.tmp /etc/nix/nix.conf"
        fi
        echo "   ‚úÖ Added $CURRENT_USER to trusted-users"

        # Restart daemon (systemd on Linux, launchd on macOS)
        if command -v systemctl &>/dev/null && systemctl is-active --quiet nix-daemon 2>/dev/null; then
            echo "   üîÑ Restarting nix-daemon (systemd)..."
            sudo systemctl restart nix-daemon
            echo "   ‚úÖ Nix daemon restarted"
        elif command -v launchctl &>/dev/null && sudo launchctl list | grep -q org.nixos.nix-daemon 2>/dev/null; then
            echo "   üîÑ Restarting nix-daemon (launchd)..."
            sudo launchctl kickstart -k system/org.nixos.nix-daemon
            echo "   ‚úÖ Nix daemon restarted"
        fi
    fi
fi
'''

["nix:cache:enable"]
description = "üíæ Enable project-specific binary cache (Cachix)"
env.CACHIX_NAME = "{{ vars.cachix_name }}"
run = '''
#!/usr/bin/env bash
set -euo pipefail

echo "üíæ Configuring binary cache..."
echo ""

# Install cachix if needed
if ! command -v cachix &>/dev/null; then
    echo "Installing cachix..."
    nix-env -iA cachix -f https://cachix.org/api/v1/install
fi

# Configure cache
echo "Adding ${CACHIX_NAME} cache..."
cachix use "$CACHIX_NAME"

echo ""
echo "‚úÖ Binary cache configured!"
echo "   Subsequent builds will use cached binaries when available"
'''

["nix:cache:push"]
description = "üì§ Push build results to binary cache"
env.CACHIX_NAME = "{{ vars.cachix_name }}"
run = '''
#!/usr/bin/env bash
set -euo pipefail

echo "üì§ Pushing to binary cache..."
echo ""

if [ -z "${CACHIX_AUTH_TOKEN:-}" ]; then
    echo "‚ùå CACHIX_AUTH_TOKEN not set"
    echo "   Set your token to push to the cache"
    exit 1
fi

cd "$FLAKE_DIR"

# Build and push
echo "Building and pushing to ${CACHIX_NAME}..."
nix build --json | jq -r '.[].outputs | to_entries[].value' | cachix push "$CACHIX_NAME"

echo ""
echo "‚úÖ Successfully pushed to cache!"
'''