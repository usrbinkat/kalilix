#!/usr/bin/env bash
# Nix Bootstrap - Platform-aware Lix installer
# Handles Lix/Nix installation for containers, native Linux, macOS, and WSL

set -euo pipefail

# Configuration
NIX_INSTALLER_URL="${NIX_INSTALLER_URL:-https://install.lix.systems/lix}"
PLATFORM="${1:-auto}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Utility functions
log() {
    echo -e "${GREEN}[NIX-BOOTSTRAP]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1" >&2
    exit 1
}

warn() {
    echo -e "${YELLOW}[WARN]${NC} $1" >&2
}

info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

# Check if Nix is already installed
check_existing() {
    if command -v nix &>/dev/null; then
        log "Nix is already installed: $(nix --version)"
        echo ""
        echo "To reinstall, first uninstall with:"
        echo "  /nix/nix-installer uninstall"
        echo "or"
        echo "  mise run nix:uninstall"
        exit 0
    fi
}

# Detect platform if auto
detect_platform() {
    if [ "$PLATFORM" = "auto" ]; then
        if [ -f /.dockerenv ] || [ -n "${container:-}" ]; then
            PLATFORM="container"
        elif [ -n "${WSL_DISTRO_NAME:-}" ]; then
            PLATFORM="wsl"
        elif [[ "$OSTYPE" == "darwin"* ]]; then
            PLATFORM="macos"
        else
            PLATFORM="linux"
        fi
    fi
    log "Detected platform: $PLATFORM"
}

# Install for container environment (Docker/Podman)
install_container() {
    log "Installing Lix for container environment..."
    echo ""
    info "Lix installer - using linux planner for containers"

    curl --proto '=https' --tlsv1.2 -sSf -L "$NIX_INSTALLER_URL" | sh -s -- install linux \
        --no-confirm \
        --extra-conf "experimental-features = nix-command flakes" \
        --extra-conf "max-jobs = auto" \
        --extra-conf "cores = 0"

    # Source Nix profile
    export PATH="${PATH}:/nix/var/nix/profiles/default/bin"

    log "✅ Container installation complete!"
}

# Install for WSL environment
install_wsl() {
    log "Installing Lix for WSL environment..."
    echo ""

    # Check if systemd is available
    if systemctl --version &>/dev/null 2>&1; then
        info "WSL with systemd detected"
    else
        info "WSL without systemd detected"
    fi

    # Lix installer - use linux subcommand for WSL
    curl --proto '=https' --tlsv1.2 -sSf -L "$NIX_INSTALLER_URL" | sh -s -- install linux \
        --no-confirm \
        --extra-conf "experimental-features = nix-command flakes" \
        --extra-conf "max-jobs = auto" \
        --extra-conf "cores = 0"

    log "✅ WSL installation complete!"
}

# Install for native Linux
install_linux() {
    log "Installing Lix for Linux..."
    echo ""
    info "Lix installer with multi-user daemon mode"

    curl --proto '=https' --tlsv1.2 -sSf -L "$NIX_INSTALLER_URL" | sh -s -- install linux \
        --no-confirm \
        --extra-conf "experimental-features = nix-command flakes" \
        --extra-conf "max-jobs = auto" \
        --extra-conf "cores = 0"

    log "✅ Linux installation complete!"
}

# Install for macOS
install_macos() {
    log "Installing Lix for macOS..."
    echo ""
    info "Using Lix installer with multi-user daemon"

    # macOS uses the 'macos' subcommand
    curl --proto '=https' --tlsv1.2 -sSf -L "$NIX_INSTALLER_URL" | sh -s -- install macos \
        --no-confirm \
        --extra-conf "experimental-features = nix-command flakes" \
        --extra-conf "max-jobs = auto" \
        --extra-conf "cores = 0"

    log "✅ macOS installation complete!"
}

# Verify installation
verify_installation() {
    echo ""
    log "Verifying installation..."

    # Source the profile if needed
    if [ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
        . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
    elif [ -f "$HOME/.nix-profile/etc/profile.d/nix.sh" ]; then
        . "$HOME/.nix-profile/etc/profile.d/nix.sh"
    fi

    # Add to PATH for container installations
    export PATH="${PATH}:/nix/var/nix/profiles/default/bin"

    if command -v nix &>/dev/null; then
        NIX_VERSION=$(nix --version)
        log "✅ Lix installed successfully!"
        echo ""
        echo "Version: $NIX_VERSION"

        # Check if it's actually Lix
        if echo "$NIX_VERSION" | grep -qi "lix"; then
            log "✅ Using Lix (Nix community fork)"
        else
            warn "⚠️  Using CppNix instead of Lix"
        fi
        echo ""

        # Test flakes
        if nix flake --help &>/dev/null 2>&1; then
            log "✅ Flakes enabled"
        else
            warn "⚠️  Flakes not enabled"
        fi

        # Show receipt location if exists
        if [ -f /nix/receipt.json ]; then
            info "Installation receipt: /nix/receipt.json"
        fi
    else
        error "Installation verification failed!"
    fi
}

# Main installation flow
main() {
    echo "╔══════════════════════════════════════════════════════════════╗"
    echo "║          Lix Bootstrap Installer (Nix Fork)                   ║"
    echo "╚══════════════════════════════════════════════════════════════╝"
    echo ""

    # Check for existing installation
    check_existing

    # Check prerequisites
    if ! command -v curl &>/dev/null; then
        error "curl is required but not installed"
    fi

    # Detect platform
    detect_platform

    # Install based on platform
    case "$PLATFORM" in
        container|docker)
            install_container
            ;;
        wsl)
            install_wsl
            ;;
        linux)
            install_linux
            ;;
        macos|darwin)
            install_macos
            ;;
        *)
            error "Unsupported platform: $PLATFORM"
            ;;
    esac

    # Verify the installation
    verify_installation

    echo ""
    log "Installation complete!"
    echo ""
    echo "Next steps:"
    echo "  1. Restart your shell or source the Nix profile"
    echo "  2. Run 'nix --version' to verify"
    echo "  3. Run 'mise run shell' to enter development environment"
}

# Execute main
main "$@"