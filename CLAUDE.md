# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Kalilix is a Nix flakes-based polyglot development environment that brings Kali Linux-style security tooling to any platform (macOS, Linux, WSL, containers) without virtualization overhead. It uses a layered architecture combining Nix for deterministic package management, Mise for task automation, and systemd-enabled containers for reproducible development.

## Core Architecture

### Layered System Design

1. **Nix Flake Layer** (`flake.nix`): Entry point for all package management and development shells
2. **Development Shells** (`modules/devshells/`): Language-specific environments (base, python, go, rust, node, devops, full)
3. **Task Orchestration** (`.mise.toml` + `.config/mise/toml/*.toml`): Workflow automation via Mise
4. **Container Platform** (`.devcontainer/`): Systemd-enabled Debian Trixie container with multi-user Nix daemon

### Key Technology Stack

- **Nix Flakes**: Deterministic builds, pinned in `flake.lock`
- **Mise**: Task runner and environment manager (replaces Make/Just)
- **Systemd**: Service management in containers (enables proper Nix daemon)
- **Binary Caches**: Cachix + NixOS cache for pre-built packages

## Development Shells

The project provides specialized shells via `nix develop`:

```bash
nix develop              # Base shell (default)
nix develop .#python     # Python 3.12 + MCP servers
nix develop .#go         # Go 1.23
nix develop .#rust       # Rust stable with rust-analyzer
nix develop .#node       # Node.js 22 LTS
nix develop .#devops     # kubectl, helm, pulumi, cloud CLIs
nix develop .#full       # All language toolchains combined
```

**Shell Architecture**:
- Base shell (`modules/devshells/base.nix`): Common tools, locale setup, MCP integration
- Extension pattern: Language shells extend base via `extendShell` helper in `modules/devshells/default.nix`
- Each shell sets `KALILIX_SHELL` env var to track active environment

## Common Development Commands

### Mise Task System

All workflow automation uses Mise. Tasks are split across files in `.config/mise/toml/`:

```bash
# Core workflows
mise run help            # Show all available commands
mise run setup           # First-time environment setup
mise run status          # Check environment health
mise run shell           # Enter default Nix shell

# Nix operations
mise run nix:install     # Install Nix (auto-detects platform)
mise run nix:shell <name>  # Enter specific shell (python, go, etc)
mise run nix:update      # Update flake.lock
mise run nix:build       # Build current configuration
mise run nix:gc          # Garbage collect Nix store
mise run nix:doctor      # Health check Nix installation

# Container operations
mise run docker:up       # Start systemd devcontainer
mise run docker:down     # Stop container gracefully
mise run docker:shell    # Exec into running container
mise run docker:build    # Rebuild container image

# Maintenance
mise run clean           # Clean build artifacts
```

### Mise Configuration Structure

- `.mise.toml`: Main config, imports task files, defines hooks
- `.config/mise/toml/main.toml`: Help, setup, status, shell commands
- `.config/mise/toml/nix.toml`: Nix package manager operations
- `.config/mise/toml/docker.toml`: Container lifecycle management
- `.config/mise/toml/dev.toml`: Development-specific tasks
- `.config/mise/toml/setup.toml`: Initialization and platform detection

### Nix Flake Operations

```bash
# Direct Nix commands (when not using Mise)
nix flake check          # Validate flake.nix
nix flake update         # Update all inputs
nix flake show           # Display outputs
nix build                # Build default package
nix develop --impure     # Enter dev shell (--impure allows env vars)
```

## Project Structure Patterns

### Nix Module Organization

```
modules/
├── devshells/
│   ├── default.nix     # Shell definitions + extendShell helper
│   └── base.nix        # Base environment with common tools
└── packages/
    └── npm/            # Node packages via node2nix
        ├── default.nix
        ├── node-packages.nix  # Generated by node2nix
        └── pulumi-mcp-wrapper.nix  # Custom wrapper for cache handling
```

### Container Architecture

- **Base Image**: Debian Trixie (testing) for modern package availability
- **Init System**: Systemd (required for multi-user Nix daemon)
- **Nix Setup**: Multi-user installation in `/nix` with systemd service
- **User Model**: `debian` user in `nixbld` group for Nix access
- **Volumes**: Persistent Nix store, Docker socket passthrough for DooD

Important: The container uses systemd as PID 1, which means:
- Services are managed via `systemctl` inside container
- Nix daemon runs as `nix-daemon.service`
- Graceful shutdown requires `docker compose down` (not `kill`)

## MCP (Model Context Protocol) Integration

The project includes pre-configured MCP servers for AI assistance:

**Python MCP Servers** (in python shell):
- `mcp-server-git`: Git operations
- `mcp-server-fetch`: Web resource retrieval
- Official Python MCP packages in base Python environment

**Node MCP Servers** (in base shell):
- `@anthropic-ai/claude-code`: Claude Code CLI
- `server-perplexity-ask`: Perplexity API integration
- `pulumi-mcp-server` (via wrapper): Infrastructure-as-code assistance

**Configuration**: `.mcp.json.example` shows structure. User creates `.mcp.json` with API keys.

## Important Development Patterns

### Locale Handling

The project fixes common locale issues in Nix containers:

```bash
export LOCALE_ARCHIVE="${pkgs.glibcLocales}/lib/locale/locale-archive"
export LANG=C.UTF-8
export LC_CTYPE=C.UTF-8
```

This is set in `modules/devshells/base.nix` shellHook and `.devcontainer/rootfs/etc/profile.d/02-locale-fix.sh`.

### Platform Detection

Environment detects runtime context:

```bash
# In container: KALILIX_IN_CONTAINER or /.dockerenv
# In WSL: WSL_DISTRO_NAME env var
# Native: Neither of above
```

Set via `mise run setup:detect-platform`.

### Adding New Nix Packages

1. Edit appropriate shell in `modules/devshells/default.nix`
2. Add package to `packages` list
3. Optionally add setup in `shellHook`
4. Test: `nix develop .#<shell-name>`
5. Update flake.lock if needed: `nix flake update`

### Adding Node Packages via node2nix

1. Edit `modules/packages/npm/package.json`
2. Run `node2nix` to regenerate `node-packages.nix`
3. Import in shell via `npmPkgs."package-name"`
4. For packages with cache issues, create wrapper like `pulumi-mcp-wrapper.nix`

## Testing Workflows

### Manual Testing

```bash
# Test shell activation
nix develop .#python
python --version  # Should be 3.12.x

# Test task system
mise run status  # Should show all components

# Test container
mise run docker:up
mise run docker:shell
# Inside: systemctl status nix-daemon
```

### Flake Validation

```bash
nix flake check --impure  # Validates all outputs
nix flake show            # Lists available shells/packages
```

## Environment Variables

Key configuration vars (in `.env` or `.env.example`):

```bash
PROJECT_NAME=kalilix
PROJECT_ORG=scopecreep-zip
KALILIX_SHELL=base           # Default shell: base|python|go|rust|node|devops|full
KALILIX_PLATFORM=auto        # Platform: auto|docker|native|wsl
COMPOSE_PROJECT_NAME=kalilix
NIX_VERSION=2.24.10
```

## Git Workflow

Standard branch model:
- `main`: Stable branch
- Feature branches: `feature/description`
- Conventional commits: `feat:`, `fix:`, `docs:`, `refactor:`

### Git Staging Requirements

**CRITICAL - ALWAYS FOLLOW THESE RULES**:

1. **Review changes first** - Always run `git status` before staging any files
2. **Explicit file staging ONLY** - Use `git add file1 file2 file3` with explicit file names
3. **FORBIDDEN commands**:
   - `git add -A` (adds everything including untracked)
   - `git add -u` (updates all tracked files)
   - `git add .` (adds everything in current directory)
4. **Procedural care** - Stage only the files relevant to the current commit scope

### Git Commit Requirements

**CRITICAL - NEVER VIOLATE THESE RULES**:

1. **NO attribution lines** - NEVER add "Generated with Claude Code", "Co-Authored-By", emojis, or any attribution
2. **Purely technical** - Commits must be ONLY technical content based on `git --no-pager diff --staged`
3. **Conventional commits format** - Use semantic release format: `type(scope): subject` with detailed body
4. **No filtering** - Read FULL diff output without grep/head/tail truncation

A commit-msg hook enforces these rules and will reject commits with attribution.

## Binary Caching

The project uses binary caches to avoid rebuilding:

```bash
# Caches configured in flake.nix nixConfig:
# - https://cache.nixos.org (official)
# - https://nix-community.cachix.org
# - https://devenv.cachix.org

# Enable project cache (when configured)
mise run nix:cache:enable

# Push to cache (requires CACHIX_AUTH_TOKEN)
mise run nix:cache:push
```

## Troubleshooting Common Issues

### "Nix daemon not responding"

```bash
# In container:
sudo systemctl restart nix-daemon
systemctl status nix-daemon
```

### "Locale warnings"

Locales are handled automatically in base shell. If issues persist:
```bash
export LANG=C.UTF-8
export LC_ALL=C.UTF-8
```

### "Permission denied" on Nix operations

Ensure user is in `nixbld` group:
```bash
groups  # Should show nixbld
# Fix: sudo usermod -aG nixbld $USER
```

### Flake evaluation errors

```bash
mise run nix:doctor  # Run health check
nix flake check --impure --show-trace  # Detailed error output
```

## Performance Notes

- **First shell entry**: ~30-60s to build environment
- **Subsequent entries**: ~2-5s (cached)
- **Container startup**: ~10s (systemd init)
- **Nix builds**: Use all cores (`cores = 0` in flake.nix)

Use `mise run nix:gc --aggressive` to reclaim disk space.

## Security Considerations

- Container runs **without** `--privileged` (uses capabilities instead)
- Docker socket passthrough for DooD (not DinD)
- Secrets via environment variables (not committed)
- Supply chain: All packages pinned in `flake.lock`

## Platform-Specific Notes

### macOS
- Nix runs natively (multi-user installation)
- Docker Desktop required for containers
- Automatic architecture detection (Intel/Apple Silicon)

### WSL
- WSL2 required for systemd support
- Docker Desktop WSL2 backend recommended
- Integration with Windows filesystem

### Native Linux
- Direct Nix installation
- Can run containers or use Nix directly
- NixOS users can import modules directly

## Documentation References

- Main README: Comprehensive overview and philosophy
- `docs/mcp-server-setup.md`: MCP configuration details
- `docs/pulumi-mcp-wrapper-implementation.md`: Custom package wrapper pattern
