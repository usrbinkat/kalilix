# Kalilix KubeVirt Deployment
# Deploy minimal VM with automated Kalilix Lix/Nix bootstrap
#
# Available Variants:
# ===================
# - Ubuntu 24.04:  ubuntu-kalilix-flake-minimal.yaml  (available)
# - Debian 13:     debian-kalilix-flake-minimal.yaml  (available)
# - Kali Linux:    kali-kalilix-flake-minimal.yaml    (active - uses golden image cloning)
#
# Quick Deploy:
# =============
# 1. Create SSH key secret (required):
#    kubectl create secret generic kargo-sshpubkey-kali \
#      --from-file=key1=$HOME/.ssh/id_ed25519.pub \
#      --namespace=default
#
# 2. Deploy golden image + VM using kustomize (creates golden image first, then clones for VM):
#    kubectl apply -k kubevirt/
#    # OR from GitHub:
#    kubectl kustomize https://github.com/usrbinkat/kalilix//kubevirt?ref=main | kubectl apply -f -
#
# 3. Monitor golden image import (one-time WAN pull):
#    kubectl get dv kali-2025-3-golden-image -w
#    # Wait for phase: Succeeded
#
# 4. Monitor VM cloning and startup:
#    kubectl get vm,vmi,dv,pvc -l app=kalilix-kali
#
# 5. Get VM IP and connect:
#    kubectl get vmi kalilix-kali -o jsonpath='{.status.interfaces[0].ipAddress}'
#    ssh kali@<VM_IP>
#
# Cleanup:
# ========
# kubectl delete vm kalilix-kali
# kubectl delete dv kalilix-kali-root kali-2025-3-golden-image
# kubectl delete pvc kalilix-kali-root kali-2025-3-golden-image
# kubectl delete secret kali-kalilix-userdata kargo-sshpubkey-kali
#
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: default

# Generate secrets from cloud-init userdata files
secretGenerator:
  # Ubuntu variant (commented for Kali testing)
  # - name: kalilix-userdata
  #   files:
  #     - userdata=kalilix-userdata.yaml
  #   options:
  #     disableNameSuffixHash: true

  # Debian variant (commented for Kali testing)
  # - name: debian-kalilix-userdata
  #   files:
  #     - userdata=debian-kalilix-userdata.yaml
  #   options:
  #     disableNameSuffixHash: true

  # Kali Linux variant - ACTIVE
  - name: kali-kalilix-userdata
    files:
      - userdata=kali-kalilix-userdata.yaml
    options:
      disableNameSuffixHash: true

# Golden Images - create these FIRST (one-time registry pulls)
# VMs clone from golden images for fast deployment
resources:
  # Kali Linux 2025.3 golden image
  - kali-2025-3-golden-image.yaml

# VirtualMachine resources
# Comment/uncomment to choose which variant to deploy
# NOTE: VMs require corresponding golden images to exist first

  # Ubuntu 24.04 (commented for Kali testing)
  # - ubuntu-kalilix-flake-minimal.yaml

  # Debian 13 (Trixie) (commented for Kali testing)
  # - debian-kalilix-flake-minimal.yaml

  # Kali Linux 2025.3 - ACTIVE (clones from kali-2025-3-golden-image)
  - kali-kalilix-flake-minimal.yaml

# Common labels for all resources
labels:
  - pairs:
      app.kubernetes.io/managed-by: kustomize
      app.kubernetes.io/part-of: kalilix

# Metadata annotations
commonAnnotations:
  kalilix.io/repo: "https://github.com/usrbinkat/kalilix"
  kalilix.io/description: "Kalilix minimal development environment with automated Lix/Nix bootstrap"
